rules_version = '2';

/**
 * Reglas de Seguridad de Firestore para AppLectura
 * 
 * Estructura de datos:
 * - /users/{userId} - Perfiles de usuario
 * - /textos/{textoId} - Textos pedag칩gicos
 * - /students/{studentId}/progress/{textoId} - Progreso de estudiantes
 * - /evaluaciones/{evalId} - Evaluaciones completas
 * - /notifications/{notifId} - Notificaciones para docentes
 */

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ========================================
    // HELPER FUNCTIONS
    // ========================================
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(uid) {
      return isAuthenticated() && request.auth.uid == uid;
    }
    
    function getUserRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }
    
    function isEstudiante() {
      return isAuthenticated() && getUserRole() == 'estudiante';
    }
    
    function isDocente() {
      return isAuthenticated() && getUserRole() == 'docente';
    }
    
    function isDocenteOf(estudianteUid) {
      return isDocente() && 
             get(/databases/$(database)/documents/users/$(estudianteUid)).data.docenteAsignado == request.auth.uid;
    }

    function isCourseTeacherForProgress(courseId, estudianteUid) {
      return isDocente() &&
             courseId != null &&
             exists(/databases/$(database)/documents/courses/$(courseId)/students/$(estudianteUid)) &&
             get(/databases/$(database)/documents/courses/$(courseId)).data.docenteUid == request.auth.uid;
    }

    function isCourseOwner(courseId) {
      return isDocente() &&
             get(/databases/$(database)/documents/courses/$(courseId)).data.docenteUid == request.auth.uid;
    }

    // (helpers eliminados si no se usan para evitar warnings de lint)
    
    // ========================================
    // COLECCI칍N: USERS
    // ========================================
    
    match /users/{userId} {
      // Leer: Cualquier usuario autenticado puede leer perfiles
      allow read: if isAuthenticated();
      
      // Escribir: Solo el due침o puede crear/actualizar su perfil
      allow create: if isOwner(userId) && 
                       request.resource.data.uid == userId &&
                       request.resource.data.role in ['estudiante', 'docente'];
      
      allow update: if isOwner(userId);
      
      // No se permite eliminar usuarios (soft delete por admin)
      allow delete: if false;
      
      // ========================================
      // SUBCOLECCI칍N: SESSIONS (anidada en /users)
      // ========================================
      
      match /sessions/{sessionId} {
        // Leer: Solo el due침o de la sesi칩n
        allow read: if isOwner(userId);
        
        // Escribir: Solo el due침o puede crear/actualizar sus sesiones
        allow create, update: if isOwner(userId);
        
        // Eliminar: Solo el due침o (para limpieza de sesiones antiguas)
        allow delete: if isOwner(userId);
      }

      // ========================================
      // SUBCOLECCI칍N: DRAFT_BACKUPS (write-only airbag)
      // ========================================

      match /draftBackups/{docId} {
        // Leer/Escribir: Solo el due침o (aunque la app actual lo use write-only)
        allow read: if isOwner(userId);
        allow create, update: if isOwner(userId);
        allow delete: if isOwner(userId);
      }
    }
    
    // ========================================
    // COLECCI칍N: TEXTOS
    // ========================================
    
    match /textos/{textoId} {
      // Leer: 
      // - Cualquier usuario autenticado puede leer textos
      // - La l칩gica de acceso por curso se maneja a nivel de aplicaci칩n
      // - Esto es necesario porque los estudiantes acceden a textos via cursos,
      //   no via asignaci칩n directa, y el campo `asignadoA` es legacy
      allow read: if isAuthenticated();
      
      // Crear: Solo docentes
      allow create: if isDocente() && 
                       request.resource.data.docenteUid == request.auth.uid;
      
      // Actualizar: Solo el docente due침o
      allow update: if isDocente() && resource.data.docenteUid == request.auth.uid;
      
      // Eliminar: Solo el docente due침o (mejor usar soft delete)
      allow delete: if isDocente() && resource.data.docenteUid == request.auth.uid;
    }
    
    // ========================================
    // SUBCOLECCI칍N: PROGRESS (anidada en /students)
    // ========================================
    
    match /students/{studentId}/progress/{textoId} {
      // Leer:
      // - El propio estudiante
      // - Su docente asignado
      // - Docente del curso
      allow read: if isAuthenticated() && (
                    request.auth.uid == studentId || 
                    isDocenteOf(studentId) || 
                    (resource.data.sourceCourseId != null && isCourseTeacherForProgress(resource.data.sourceCourseId, studentId))
                  );
      
      // 游댑 SIMPLIFICADO: Permitir a cualquier usuario autenticado escribir su propio progreso
      // La validaci칩n de curso se hace a nivel de aplicaci칩n
      allow create: if isAuthenticated() && request.auth.uid == studentId;
      
      // Actualizar: 
      // - El propio estudiante
      // - 游 El docente del curso (para resetear artefactos/oportunidades)
      allow update: if isAuthenticated() && (
                      request.auth.uid == studentId ||
                      isDocenteOf(studentId) ||
                      (resource.data.sourceCourseId != null && isCourseTeacherForProgress(resource.data.sourceCourseId, studentId))
                    );
      
      // Eliminar: Solo el docente (para resetear progreso completo)
      allow delete: if isDocenteOf(studentId) || 
                      (resource.data.sourceCourseId != null && isCourseTeacherForProgress(resource.data.sourceCourseId, studentId));
    }

    // ========================================
    // SUBCOLECCI칍N: NOTIFICATIONS (notificaciones para estudiantes)
    // ========================================
    
    match /students/{studentId}/notifications/{notifId} {
      // Leer: Solo el estudiante due침o
      allow read: if isOwner(studentId);
      
      // Crear: Docentes autenticados pueden crear notificaciones para estudiantes
      allow create: if isDocente();
      
      // Actualizar: Solo el estudiante (para marcar como le칤da)
      allow update: if isOwner(studentId);
      
      // Eliminar: El estudiante o el docente que la cre칩
      allow delete: if isOwner(studentId) || 
                      (isDocente() && resource.data.docenteUid == request.auth.uid);
    }
    
    // ========================================
    // COLECCI칍N: EVALUACIONES
    // ========================================
    
    match /evaluaciones/{evalId} {
      // Leer:
      // - El propio estudiante
      // - Su docente asignado
      allow read: if isOwner(resource.data.estudianteUid) || 
                     isDocenteOf(resource.data.estudianteUid);
      
      // Crear: Solo estudiantes (cuando env칤an una evaluaci칩n)
      allow create: if isEstudiante() && 
                       request.resource.data.estudianteUid == request.auth.uid;
      
      // No se permite actualizar/eliminar evaluaciones (inmutables)
      allow update, delete: if false;
    }
    
    // ========================================
    // COLECCI칍N: NOTIFICATIONS
    // ========================================
    
    match /notifications/{notifId} {
      // Leer: Solo el destinatario (docente)
      allow read: if isOwner(resource.data.destinatarioUid);
      
      // Crear: Sistema o estudiante (para alertas pedag칩gicas)
      allow create: if isAuthenticated();
      
      // Actualizar: Solo el destinatario (para marcar como le칤da)
      allow update: if isOwner(resource.data.destinatarioUid) &&
                       request.resource.data.diff(resource.data).affectedKeys().hasOnly(['leida']);
      
      // Eliminar: Solo el destinatario
      allow delete: if isOwner(resource.data.destinatarioUid);
    }
    
    // ========================================
    // COLECCI칍N: ACTIVE_SESSIONS (Control de sesi칩n 칰nica)
    // ========================================
    
    match /active_sessions/{userId} {
      // Leer: Solo el due침o de la sesi칩n
      allow read: if isOwner(userId);
      
      // Crear/Actualizar: Solo el due침o puede gestionar su sesi칩n activa
      allow create, update: if isOwner(userId) &&
                               request.resource.data.userId == userId;
      
      // Eliminar: Solo el due침o (al cerrar sesi칩n)
      allow delete: if isOwner(userId);
    }

    // ========================================
    // COLECCI칍N: COURSES (cursos tipo classroom)
    // ========================================

    match /courses/{courseId} {
      // Leer: Solo usuarios autenticados (evita exposici칩n p칰blica)
      allow read: if isAuthenticated();

      // Crear: Solo docentes para s칤 mismos
      allow create: if isDocente() && request.resource.data.docenteUid == request.auth.uid;

      // Actualizar/Eliminar: Solo docente due침o
      allow update, delete: if isCourseOwner(courseId);

      match /students/{studentId} {
        // Leer: Docente due침o o el mismo estudiante
        allow read: if isCourseOwner(courseId) || isOwner(studentId);

        // Crear: El propio estudiante al unirse al curso
        allow create: if isOwner(studentId) &&
                        request.resource.data.estudianteUid == request.auth.uid &&
                        (
                          // Respetar autoApprove: si est치 desactivado, solo puede quedar en pending
                          (get(/databases/$(database)/documents/courses/$(courseId)).data.autoApprove == false && request.resource.data.estado == 'pending') ||
                          (get(/databases/$(database)/documents/courses/$(courseId)).data.autoApprove != false && request.resource.data.estado == 'active')
                        );

        // Actualizar: Docente due침o o el estudiante para campos limitados
        allow update: if isCourseOwner(courseId) ||
                        (isOwner(studentId) &&
                          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['ultimoAcceso']));

        // Eliminar: Solo docente due침o (baja del curso)
        allow delete: if isCourseOwner(courseId) || isOwner(studentId);
      }
    }

    // ========================================
    // COLECCI칍N: COURSE_CODES (mapear c칩digo -> curso)
    // ========================================

    match /courseCodes/{code} {
      // Leer: Solo usuarios autenticados (unirse a curso requiere sesi칩n)
      allow read: if isAuthenticated();

      // Crear: Solo docente due침o del c칩digo
      allow create: if isDocente() && request.resource.data.docenteUid == request.auth.uid;

      // Actualizar/Eliminar: Solo docente due침o
      allow update, delete: if isDocente() && (
        // caso normal
        (resource.data.docenteUid == request.auth.uid) ||
        // compatibilidad legacy: si el code apunta a un courseId y el docente es due침o del curso
        (resource.data.courseId != null && isCourseOwner(resource.data.courseId))
      );
    }
    
    // ========================================
    // REGLA POR DEFECTO: DENEGAR TODO LO DEM츼S
    // ========================================
    
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

