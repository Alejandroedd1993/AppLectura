// Tests unitarios para SistemaEvaluacion
import React from 'react';
import { screen } from '@testing-library/react';
import userEvent from '@testing-library/user-event';
import SistemaEvaluacion from '../../../src/components/SistemaEvaluacion';
import { renderWithContext, createTestText } from '../../testUtils';
import { PedagogyProvider } from '../../../src/context/PedagogyContext';

// Mock de OpenAI con funciÃ³n mock estÃ¡tica
const mockOpenAI = {
  chat: {
    completions: {
      create: jest.fn()
    }
  }
};

// Mock del mÃ³dulo sistemaEvaluacionInteligente
jest.mock('../../../src/utils/sistemaEvaluacionInteligente', () => ({
  NIVELES_ESTUDIANTE: {
    BASICO: {
      label: 'BÃ¡sico',
      descripcion: 'Nivel bÃ¡sico de comprensiÃ³n',
      dificultad: 1
    },
    INTERMEDIO: {
      label: 'Intermedio',
      descripcion: 'Nivel intermedio de anÃ¡lisis',
      dificultad: 2
    },
    AVANZADO: {
      label: 'Avanzado',
      descripcion: 'AnÃ¡lisis profundo y crÃ­tico',
      dificultad: 3
    }
  },
  GeneradorPreguntasInteligente: {
    generarPreguntasContextuales: jest.fn(),
    validarYCorregirPreguntas: jest.fn(),
    ajustarDificultad: jest.fn(),
    limpiarHistorial: jest.fn()
  },
  EvaluadorRespuestasInteligente: {
    evaluarRespuestaCompleta: jest.fn(),
    generarFeedbackPersonalizado: jest.fn(),
    calcularPuntuacion: jest.fn()
  }
}));

// Mock de OpenAI
jest.mock('openai', () => ({
  OpenAI: jest.fn(() => mockOpenAI)
}));

describe('SistemaEvaluacion', () => {
  beforeEach(() => {
    jest.clearAllMocks();
    // Reset OpenAI mock
    mockOpenAI.chat.completions.create.mockResolvedValue({
      choices: [{
        message: {
          content: JSON.stringify({
            preguntas: [
              {
                pregunta: 'Â¿CuÃ¡l es el tema principal?',
                opciones: ['A', 'B', 'C', 'D'],
                respuestaCorrecta: 'A'
              }
            ]
          })
        }
      }]
    });
    
    // Mock de evaluador
    const mockEvaluadorRespuestasInteligente = require('../../../src/utils/sistemaEvaluacionInteligente').EvaluadorRespuestasInteligente;
    mockEvaluadorRespuestasInteligente.evaluarRespuestaCompleta.mockResolvedValue({
      puntuacion: 10,
      feedback: 'Respuesta correcta. Buen anÃ¡lisis.',
      areas_mejora: []
    });
  });

  const mockProps = {
    onClose: jest.fn()
  };

  const contextValue = {
    texto: createTestText(500),
    openAIApiKey: 'test-key',
    modoOscuro: false,
    setTexto: jest.fn(),
    openai: mockOpenAI
  };

  const renderWithPedagogy = (ui, opts) => renderWithContext(<PedagogyProvider>{ui}</PedagogyProvider>, opts);

  describe('Renderizado inicial', () => {
    test('debe renderizar el componente correctamente', () => {
      renderWithPedagogy(<SistemaEvaluacion {...mockProps} />, { contextValue });
      
      expect(screen.getByText('ðŸ“âœ… Sistema de EvaluaciÃ³n')).toBeInTheDocument();
      expect(screen.getByText(/evaluar tu comprensiÃ³n lectora/i)).toBeInTheDocument();
    });

    test('debe mostrar los niveles de estudiante disponibles', () => {
      renderWithPedagogy(<SistemaEvaluacion {...mockProps} />, { contextValue });
      
      expect(screen.getByText('BÃ¡sico')).toBeInTheDocument();
      expect(screen.getByText('Intermedio')).toBeInTheDocument(); 
      expect(screen.getByText('Avanzado')).toBeInTheDocument();
    });

    test('debe tener el nivel intermedio seleccionado por defecto', () => {
      renderWithPedagogy(<SistemaEvaluacion {...mockProps} />, { contextValue });
      
      const intermedioButton = screen.getByRole('button', { name: /intermedio/i });
      expect(intermedioButton).toBeInTheDocument();
      // Verificar la descripciÃ³n asociada al nivel por defecto
      expect(screen.getByText(/estudiantes con conocimientos medios/i)).toBeInTheDocument();
    });
  });

  describe('SelecciÃ³n de nivel', () => {
    test('debe mostrar la descripciÃ³n del nivel', () => {
      renderWithPedagogy(<SistemaEvaluacion {...mockProps} />, { contextValue });
      
      expect(screen.getByText(/estudiantes con conocimientos medios/i)).toBeInTheDocument();
    });
  });

  describe('Sin texto cargado', () => {
    test('debe mostrar mensaje cuando no hay texto', () => {
      const contextSinTexto = { ...contextValue, texto: '' };
      renderWithPedagogy(<SistemaEvaluacion {...mockProps} />, { contextValue: contextSinTexto });
      
      expect(screen.getByText(/Carga un texto para comenzar/i)).toBeInTheDocument();
    });
  });

  describe('Limpieza y cancelaciÃ³n', () => {
    test('debe cancelar operaciones en curso al desmontar', () => {
      const { unmount } = renderWithPedagogy(<SistemaEvaluacion {...mockProps} />, { contextValue });
      
      expect(() => unmount()).not.toThrow();
    });
  });
});
